<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Salvando el Mar - Marinero</title>
    
    <!-- Google Analytics 4 tag (gtag.js) - ID G-SHSF8X0KGP -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SHSF8X0KGP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-SHSF8X0KGP'); 
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CONFIGURACIÓN TAILWIND -->
    <script>
      function configureTailwind() {
        if (window.tailwind) {
          window.tailwind.config = {
            theme: {
              extend: {
                fontFamily: {
                  pixel: ['"Jersey 10"', 'sans-serif'],
                },
                colors: {
                    brandRed: '#d2362a', 
                    brandYellow: '#facc15',
                    brandBlue: '#0369a1',
                    brandBlueLight: '#38bdf8',
                }
              },
            },
          };
        }
      }
    </script>
    <script src="https://cdn.tailwindcss.com" onload="configureTailwind()"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            collection, 
            addDoc,     
            query,      
            limit       
        };
    </script>

    <style>
      /* GLOBAL STYLES */
      html, body {
        margin: 0;
        padding: 0;
        background-color: #020617; 
        font-family: 'Jersey 10', sans-serif !important; 
        touch-action: none; 
        overflow: hidden; 
        width: 100%;
        height: 100%;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      #root {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      canvas {
        image-rendering: pixelated; 
        display: block;
      }
      
      .scanline {
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
        background-size: 100% 4px;
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        pointer-events: none;
        z-index: 50;
      }

      .text-shadow-retro {
        text-shadow: 2px 2px 0px #000;
      }

      .btn-pixel-wrapper:active .pixel-inner {
        transform: translateY(4px);
      }
      .btn-pixel-wrapper:active {
        transform: none; 
      }

      @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      .animate-logo-pulse {
        animation: heartbeat 2s infinite ease-in-out;
      }

      .pixel-clip {
        clip-path: polygon(
          0px 4px, 4px 4px, 4px 0px,
          calc(100% - 4px) 0px, calc(100% - 4px) 4px, 100% 4px,
          100% calc(100% - 4px), calc(100% - 4px) calc(100% - 4px), calc(100% - 4px) 100%,
          4px 100%, 4px calc(100% - 4px), 0px calc(100% - 4px)
        );
      }
    </style>
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Trash2, Award, Play, RotateCcw, ChevronLeft, ChevronRight, ArrowUp, Skull, Gamepad2, Move, UserPlus, Save, Tally3, X } from 'lucide-react';

        // --- CONFIGURACIÓN DE FIREBASE ---
        // Se usa la configuración inyectada por Canvas o la manual si no existe.
        
        const MANUAL_APP_ID = 'marinero-sts'; 

        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyASF_CP0H0T8hUDIN8EyZncesXr2F92iBw", 
            authDomain: "marinero-sts.firebaseapp.com",
            projectId: "marinero-sts",
            storageBucket: "marinero-sts.firebasestorage.app", 
            messagingSenderId: "818191028982", 
            appId: "1:818191028982:web:c91f28bcf43c4bc14692d7", 
            measurementId: "G-SHSF8X0KGP" 
        };

        const MANUAL_AUTH_TOKEN = null;

        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_APP_ID;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : MANUAL_AUTH_TOKEN;
        
        // Función de utilidad para manejar Firebase
        const useFirebase = () => {
            if (window.firebase) return window.firebase;
            return {};
        };
        
        const GAME_ASSETS = {
            LOGO: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/logo1.png",
            IMAGINED_BY: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/imaginedbyBG.png",
            SPLASH_BG: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/playa1.jpg", 
            FRAME_RESULT: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/marco1.png", 
            PLAYER_MATEO: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/MateoPlayer.gif",
            PLAYER_ANA: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/ana1.gif",
            PLAYER_CARLITOS: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/carlitos1.gif",
            PLAYER_MARCO: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/marco1.gif",
            POWER_CAN: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/lata1.png",
            POWER_BUBBLE: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/bubble1.png",
            MUSIC_BG: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/408efe5d77d229042ea878ad5cdd219df39c73ce/Untitled.mp3",
            SFX_COLLECT: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/ec7e957306cc84aaca09b7ae617afd65bf33f921/obj.wav",
            SFX_EXPLOSION: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/ec7e957306cc84aaca09b7ae617afd65bf33f921/explosion.wav",
            SFX_POWERUP: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/4d481af71e4a117e675f085b04748bb23394c7f1/powerup1.wav",
            SFX_POWER_DESTROY: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/4d481af71e4a117e675f085b04748bb23394c7f1/powerupdestroy1.wav",
            TRASH_BOTTLE: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/botella.png",
            TRASH_BAG: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/bolsa.png",
            TRASH_TIRE: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/llanta.png",
            TRASH_BOOT: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/bota.png",
            ENEMY_JELLYFISH: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/medusa.png",
            ENEMY_SHARK: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/tiburon.png",
            BG_LAYER: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/fondo1.png",
            DECO_ALGA_1: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/alga1.png",
            DECO_ALGA_2: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/alga2.png",
            DECO_ALGA_3: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/alga3.png",
            DECO_CORAL_1: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral1.png",
            DECO_CORAL_2: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral2.png",
            DECO_CORAL_3: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral3.png",
            DECO_CORAL_4: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral4.png",
            DECO_CORAL_5: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral5.png",
            DECO_ROCK_1: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/roca1.png"
        };

        const CUSTOM_MESSAGES = [
            { title: "Rescatista de Tortugas", message: "Al quitar esas bolsas, ¡las tortugas nada orgullosas!" },
            { title: "Amigo del Delfín", message: "Sin basura flotando, el delfín sigue saltando." },
            { title: "Héroe del Pelícano", message: "Sin plásticos en el pico, el pelícano come rico." },
            { title: "Defensor del Lobo de Mar", message: "El lobito descansa feliz, sin basura en su nariz." },
            { title: "Guardián de las Aves", message: "Si limpias la arena, las aves no tienen pena." },
            { title: "Salvador del Cangrejo", message: "Salvaste al cangrejo de ese plástico viejo." },
            { title: "Aliado de la Anchoveta", message: "Agua limpia y vital, para nuestro pez nacional." },
            { title: "Protector de Aletas", message: "Los peces crecen sanos si limpiamos con las manos." },
            { title: "Cuidador de Ballenas", message: "Un mar sin desechos evita muchas penas." },
            { title: "Auxilio de la Gaviota", message: "Si recoges la tapita, el ave no se debilita." },
            { title: "Doctor del Océano", message: "Curaste el agua hoy, ¡las gracias te doy!" },
            { title: "Limpiador de Arrecifes", message: "Si limpias el coral, la vida es fenomenal." },
            { title: "Héroe de la Espuma", message: "El mar respira mejor con tu gran labor." },
            { title: "Vigilante de la Marea", message: "Agua transparente, ¡ese es un mar valiente!" },
            { title: "Experto en Salud Azul", message: "El azul regresa al mar si te pones a limpiar." },
            { title: "Guardián del Plancton", message: "Microplásticos fuera, ¡la vida prospera!" },
            { title: "Defensor de las Olas", message: "Las olas rompen feliz sin basura y con barniz." },
            { title: "Protector del Fondo", message: "Bajo el mar todo brilla si limpias la orilla." },
            { title: "Escudo del Mar", message: "Proteges la vida, curando al mar su herida." },
            { title: "Rey del Ecosistema", message: "Limpiar es el tema para salvar el ecosistema." },
            { title: "Trome del Reciclaje", message: "Lo que tiras al tacho, no daña al pez, muchacho." },
            { title: "Capitán Limpieza", message: "El mar no es basurero, ¡tu cuidado es lo primero!" },
            { title: "Marinero Consciente", message: "Pez sano y sin basura, ¡es salud y frescura!" },
            { title: "Leyenda del Mar de Grau", message: "Cuidar las 200 millas es la mejor de las maravillas." },
            { title: "Cazador de Plástico", message: "La botella reciclada ya no contamina nada." },
            { title: "Salvavidas Ecológico", message: "Sacar esa red vieja, ¡a los peces libres deja!" },
            { title: "Maestro del Cuidado", message: "Si el mar está aseado, tendremos buen pescado." },
            { title: "Héroe del Litoral", message: "Tu limpieza ayuda a evitar el daño ambiental." },
            { title: "Campeón de la Costa", message: "Una costa aseada es una vida salvada." },
            { title: "Poseidón de la Limpieza", message: "Tu poder es limpiar para la vida conservar." }
        ];

        const LOGICAL_WIDTH = 450; 
        const LOGICAL_HEIGHT = 800;
        
        const PLAY_AREA = { TOP: 130, BOTTOM: 620 };
        const GRAVITY = 0.25;
        const SWIM_FORCE = -7; 
        const FRICTION = 0.96;
        
        const COLORS = {
            BRAND_RED: '#d2362a', 
            BRAND_YELLOW: '#facc15', 
            BRAND_BLUE_LIGHT: '#38bdf8',
            BRAND_BLUE_DARK: '#0369a1',
            SAND: '#fcd34d',
            BUBBLE: 'rgba(255, 255, 255, 0.6)'
        };

        const GameCanvas = ({ status, onScoreUpdate, onGameOver, playSfx, sessionId, playerSrc, joystickRef }) => {
            const canvasRef = useRef(null);
            const domPlayerRef = useRef(null);
            const requestRef = useRef(0);
            const frameCountRef = useRef(0);
            const facingRef = useRef('RIGHT');
            const [images, setImages] = useState({});
            const nextDecoSpawnRef = useRef(30);
            const keysRef = useRef(new Set());

            useEffect(() => {
                const loaded = {};
                const keys = Object.keys(GAME_ASSETS).filter(k => !k.startsWith('PLAYER_') && !k.startsWith('MUSIC') && !k.startsWith('SFX'));
                let count = 0;
                if (keys.length === 0) return;
                keys.forEach(key => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = GAME_ASSETS[key];
                    img.onload = () => { loaded[key] = img; count++; if(count === keys.length) setImages(loaded); };
                    img.onerror = () => { count++; if(count === keys.length) setImages(loaded); };
                });
            }, []);

            const gameState = useRef({
                player: { x: 50, y: LOGICAL_HEIGHT/2, vx: 0, vy: 0, width: 80, height: 80, invincible: 0, bubbleTimer: 0 },
                entities: [], decorations: [], particles: [], score: 0
            });

            useEffect(() => {
                const down = (e) => keysRef.current.add(e.key);
                const up = (e) => keysRef.current.delete(e.key);
                const touchDown = (e) => keysRef.current.add(e.detail.key);
                const touchUp = (e) => keysRef.current.delete(e.detail.key);
                window.addEventListener('keydown', down); window.addEventListener('keyup', up);
                window.addEventListener('game-input-down', touchDown); window.addEventListener('game-input-up', touchUp);
                return () => {
                    window.removeEventListener('keydown', down); window.removeEventListener('keyup', up);
                    window.removeEventListener('game-input-down', touchDown); window.removeEventListener('game-input-up', touchUp);
                };
            }, []);
            
            useEffect(() => {
                 gameState.current = {
                     player: { x: 50, y: LOGICAL_HEIGHT/2, vx: 0, vy: 0, width: 80, height: 80, invincible: 0, bubbleTimer: 0 },
                     entities: [], decorations: [], particles: [], score: 0
                };
                frameCountRef.current = 0; nextDecoSpawnRef.current = 30; keysRef.current.clear();
                facingRef.current = 'RIGHT'; onScoreUpdate(0);
            }, [sessionId, onScoreUpdate]);

            const loop = useCallback(() => {
                if (status === 'PAUSED' || status === 'GAME_OVER') return;
                const state = gameState.current; const { player } = state; const keys = keysRef.current;
                frameCountRef.current++;
                if (status === 'START' || status === 'SPLASH') return;
                const fc = frameCountRef.current;

                if (fc % 100 === 0) { 
                    const types = ['TRASH_BOTTLE', 'TRASH_TIRE', 'TRASH_BAG', 'TRASH_BOOT'];
                    const type = types[Math.floor(Math.random()*types.length)];
                    state.entities.push({ type, id: Math.random(), x: LOGICAL_WIDTH + 50, y: Math.random() * (LOGICAL_HEIGHT - 300) + 100, w: 60, h: 60, vx: -2 - Math.random(), vy: 0, asset: type });
                }
                if (fc % 180 === 0) { 
                    const types = ['ENEMY_JELLYFISH', 'ENEMY_SHARK'];
                    const type = types[Math.floor(Math.random()*types.length)];
                    const isShark = type === 'ENEMY_SHARK';
                    state.entities.push({ type, id: Math.random(), x: LOGICAL_WIDTH + 50, y: Math.random() * (LOGICAL_HEIGHT - 300) + 100, w: isShark ? 150 : 60, h: isShark ? 60 : 60, vx: isShark ? -4 - Math.random() : -2, vy: isShark ? 0 : Math.sin(fc/50)*0.5, asset: type });
                }
                if (fc % 600 === 0 && Math.random() > 0.3) {
                    state.entities.push({ type: 'POWER_UP', id: Math.random(), x: LOGICAL_WIDTH + 50, y: Math.random() * (LOGICAL_HEIGHT - 300) + 100, w: 50, h: 70, vx: -3, vy: Math.sin(fc/20)*1, asset: 'POWER_CAN' });
                }
                if (fc >= nextDecoSpawnRef.current) { 
                    const allDecos = ['DECO_ALGA_1', 'DECO_ALGA_2', 'DECO_ALGA_3', 'DECO_CORAL_1', 'DECO_CORAL_2', 'DECO_CORAL_3', 'DECO_CORAL_4', 'DECO_CORAL_5', 'DECO_ROCK_1'];
                    const assetKey = allDecos[Math.floor(Math.random()*allDecos.length)];
                    let w = 50, h = 50; 
                    if (assetKey.includes('ALGA')) { w = 40; h = 70; } else if (assetKey.includes('ROCK')) { w = 70; h = 45; } else { w = 60; h = 60; }
                    state.decorations.push({ id: Math.random(), x: LOGICAL_WIDTH + 50, y: LOGICAL_HEIGHT - h - 30 + (Math.random()*10), w: w, h: h, vx: -1.5, asset: assetKey });
                    nextDecoSpawnRef.current = fc + Math.floor(Math.random() * 80) + 40;
                }
                if (fc % 15 === 0) state.particles.push({ x: Math.random() * LOGICAL_WIDTH, y: LOGICAL_HEIGHT + 10, vx: 0, vy: -1 - Math.random()*2, life: 200, color: COLORS.BUBBLE, w: 2 + Math.random()*3, h: 2 + Math.random()*3 });

                let swim = false; let dx = 0;
                if (keys.has('ArrowUp') || keys.has(' ') || keys.has('w')) swim = true;
                if (keys.has('ArrowLeft') || keys.has('a')) dx = -1;
                if (keys.has('ArrowRight') || keys.has('d')) dx = 1;

                if (joystickRef && joystickRef.current && joystickRef.current.active) {
                    const j = joystickRef.current;
                    if (j.x > 0.2) dx = 0.25; else if (j.x < -0.2) dx = -0.25;
                    if (j.y < -0.3) { 
                        player.vy -= 0.45; 
                        if (fc % 5 === 0) state.particles.push({ x: player.x + (facingRef.current === 'RIGHT' ? 0 : player.width), y: player.y + 40, vx: (Math.random()-0.5)*2, vy: 1, life: 20, color: 'rgba(255,255,255,0.5)', w:6, h:6 });
                    }
                    if (j.y > 0.3) player.vy += 0.4;
                }

                if (swim) {
                    player.vy += SWIM_FORCE * 0.15;
                    if (fc % 5 === 0) state.particles.push({ x: player.x + (facingRef.current === 'RIGHT' ? 0 : player.width), y: player.y + 40, vx: (Math.random()-0.5)*2, vy: 1, life: 20, color: 'rgba(255,255,255,0.5)', w:6, h:6 });
                }

                if (Math.abs(dx) > 0.01) {
                    player.vx += dx * 0.2; facingRef.current = dx > 0 ? 'RIGHT' : 'LEFT';
                }

                player.vy += GRAVITY; player.vx *= FRICTION; player.vy *= FRICTION;
                player.x += player.vx; player.y += player.vy;
                
                if (player.y < PLAY_AREA.TOP) { player.y = PLAY_AREA.TOP; player.vy = 0; }
                if (player.y > PLAY_AREA.BOTTOM - player.height) { player.y = PLAY_AREA.BOTTOM - player.height; player.vy = 0; }
                if (player.x < 0) { player.x = 0; player.vx = 0; }
                if (player.x > LOGICAL_WIDTH - player.width) { player.x = LOGICAL_WIDTH - player.width; player.vx = 0; }

                if (player.invincible > 0) player.invincible--;
                if (player.bubbleTimer > 0) player.bubbleTimer--;

                state.entities.forEach(e => {
                    e.x += e.vx; e.y += e.vy;
                    if (e.asset === 'ENEMY_SHARK' && fc % 4 === 0) state.particles.push({x: e.x + e.w - 10, y: e.y + e.h / 2, vx: 2, vy: (Math.random() - 0.5) * 2, life: 25, color: 'rgba(255,255,255,0.4)', w: 5, h: 5});
                    else if (e.asset === 'ENEMY_JELLYFISH' && fc % 15 === 0) state.particles.push({x: e.x + e.w / 2, y: e.y + e.h - 10, vx: 0, vy: 1, life: 40, color: 'rgba(255,255,255,0.3)', w: 3, h: 3});
                    else if (e.type === 'POWER_UP' && fc % 10 === 0) state.particles.push({x: e.x + Math.random()*e.w, y: e.y + Math.random()*e.h, vx: 0, vy: -1, life: 20, color: '#fbbf24', w: 4, h: 4});
                    
                    if (player.x < e.x + e.w - 15 && player.x + player.width > e.x + 15 && player.y < e.y + e.h - 15 && player.y + player.height > e.y + 15) {
                        if (e.type.startsWith('TRASH')) {
                            e.delete = true; state.score += 10; onScoreUpdate(state.score); playSfx('COLLECT'); 
                            let pColor = '#fff'; if (e.type.includes('TIRE')) pColor = '#1f2937'; else if (e.type.includes('BOOT')) pColor = '#78350f'; else if (e.type.includes('BAG')) pColor = '#9ca3af'; else if (e.type.includes('BOTTLE')) pColor = '#3b82f6';
                            for(let i=0; i<8; i++) state.particles.push({x: e.x + e.w/2, y: e.y + e.h/2, vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, life: 30, color: pColor, w: 8, h:8});
                        } else if (e.type === 'POWER_UP') {
                            e.delete = true; player.bubbleTimer = 600; playSfx('POWERUP'); 
                            for(let i=0; i<15; i++) state.particles.push({x: player.x + player.width/2, y: player.y + player.height/2, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 45, color: '#fcd34d', w: 6, h:6});
                        } else if (e.type.startsWith('ENEMY')) {
                            if (player.bubbleTimer > 0) {
                                e.delete = true; playSfx('POWER_DESTROY'); 
                                for(let i=0; i<10; i++) state.particles.push({x: e.x + e.w/2, y: e.y + e.h/2, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 30, color: '#60a5fa', w: 6, h:6});
                            } else if (player.invincible === 0) { 
                                playSfx('EXPLOSION'); player.vx = 0; player.vy = 0; onGameOver(state.score); return; 
                            }
                        }
                    }
                    if (e.x < -150) e.delete = true;
                });

                state.decorations.forEach(d => { d.x += d.vx; if (d.x < -100) d.delete = true; });
                state.particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life--; });
                state.entities = state.entities.filter(e => !e.delete);
                state.decorations = state.decorations.filter(d => !d.delete);
                state.particles = state.particles.filter(p => p.life > 0);
            }, [status, onScoreUpdate, onGameOver, playSfx]);

            const draw = useCallback(() => {
                const canvas = canvasRef.current; if (!canvas) return;
                const ctx = canvas.getContext('2d'); const state = gameState.current;
                ctx.clearRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT); ctx.imageSmoothingEnabled = false;
                const grad = ctx.createLinearGradient(0, 0, 0, LOGICAL_HEIGHT);
                grad.addColorStop(0, COLORS.BRAND_BLUE_LIGHT); grad.addColorStop(1, COLORS.BRAND_BLUE_DARK);
                ctx.fillStyle = grad; ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

                if (images['BG_LAYER']) {
                    const scrollSpeed = 0.5; const bgX = -(frameCountRef.current * scrollSpeed) % LOGICAL_WIDTH;
                    ctx.drawImage(images['BG_LAYER'], Math.floor(bgX), 0, LOGICAL_WIDTH + 2, LOGICAL_HEIGHT);
                    ctx.drawImage(images['BG_LAYER'], Math.floor(bgX) + LOGICAL_WIDTH - 2, 0, LOGICAL_WIDTH + 2, LOGICAL_HEIGHT);
                }
                ctx.fillStyle = COLORS.SAND; ctx.fillRect(0, LOGICAL_HEIGHT - 40, LOGICAL_WIDTH, 40);
                if (status === 'START' || status === 'SPLASH') return;

                state.decorations.forEach(d => { if (images[d.asset]) ctx.drawImage(images[d.asset], d.x, d.y, d.w, d.h); });
                state.entities.forEach(e => {
                    if (images[e.asset]) {
                        let yOffset = 0; if (e.type === 'POWER_UP') yOffset = Math.sin(frameCountRef.current / 10) * 5;
                        ctx.drawImage(images[e.asset], e.x, e.y + yOffset, e.w, e.h);
                    } else { ctx.fillStyle = 'red'; ctx.fillRect(e.x, e.y, e.w, e.h); }
                });
                state.particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.w, p.h); });

                const p = state.player;
                if (p.bubbleTimer > 0 && images['POWER_BUBBLE']) {
                    const pulse = Math.sin(frameCountRef.current / 10) * 5;
                    ctx.globalAlpha = 0.7; ctx.drawImage(images['POWER_BUBBLE'], p.x - 20 - pulse/2, p.y - 20 - pulse/2, p.width + 40 + pulse, p.height + 40 + pulse); ctx.globalAlpha = 1.0;
                }

                if (domPlayerRef.current) {
                    const domEl = domPlayerRef.current;
                    if (status === 'PLAYING' || status === 'PAUSED') {
                        domEl.style.display = 'block';
                        const leftPct = (p.x / LOGICAL_WIDTH) * 100; const topPct = (p.y / LOGICAL_HEIGHT) * 100;
                        const wPct = (p.width / LOGICAL_WIDTH) * 100; const hPct = (p.height / LOGICAL_HEIGHT) * 100;
                        domEl.style.left = `${leftPct}%`; domEl.style.top = `${topPct}%`; domEl.style.width = `${wPct}%`; domEl.style.height = `${hPct}%`;
                        const scaleX = facingRef.current === 'LEFT' ? -1 : 1;
                        domEl.style.transform = `scaleX(${scaleX})`;
                        domEl.style.opacity = (p.invincible > 0 && Math.floor(Date.now()/100)%2 !== 0) ? '0.5' : '1';
                    } else { domEl.style.display = 'none'; }
                }
            }, [images, status]);

            useEffect(() => {
                const animate = () => { loop(); draw(); requestRef.current = requestAnimationFrame(animate); };
                requestRef.current = requestAnimationFrame(animate); return () => cancelAnimationFrame(requestRef.current);
            }, [loop, draw]);

            return (
                <div className="relative w-full h-full bg-black overflow-hidden shadow-2xl">
                    <canvas ref={canvasRef} width={LOGICAL_WIDTH} height={LOGICAL_HEIGHT} style={{ width: '100%', height: '100%', objectFit: 'fill' }} />
                    <img ref={domPlayerRef} src={playerSrc} className="absolute pointer-events-none hidden" alt="Player" style={{ imageRendering: 'pixelated', willChange: 'left, top, transform' }} />
                </div>
            );
        };

        const RegistrationModalComponent = ({ userId, regForm, setRegForm, regError, isSaving, authReady, saveUserProfile }) => (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div className="w-full max-w-sm bg-brandYellow p-2 pixel-clip shadow-[8px_8px_0px_0px_rgba(0,0,0,0.8)]">
                    <div className="bg-white p-4 pixel-clip border-4 border-brandRed">
                        <h3 className="text-3xl text-brandBlue font-bold mb-2 text-center text-shadow-retro flex items-center justify-center gap-2"><UserPlus className="w-6 h-6"/>REGISTRO</h3>
                        <p className="text-sm text-center text-slate-600 mb-4">¡Necesitamos tus datos para guardar tus logros! Esto es privado y seguro.</p>
                        <div className="text-xs text-center text-slate-400 mb-3 break-words">ID de Usuario: {userId || 'Cargando...'}</div>
                        <form onSubmit={saveUserProfile} className="flex flex-col gap-3">
                            <label className="flex flex-col text-sm font-bold text-slate-800">
                                Nombre Completo:
                                <input type="text" value={regForm.name} onChange={(e) => setRegForm(p => ({ ...p, name: e.target.value }))} className="mt-1 p-2 border-2 border-brandBlue bg-white text-slate-800 focus:outline-none focus:border-brandRed" required disabled={isSaving} />
                            </label>
                            <label className="flex flex-col text-sm font-bold text-slate-800">
                                Documento de Identidad (DNI/Cédula):
                                <input type="text" value={regForm.documentId} onChange={(e) => setRegForm(p => ({ ...p, documentId: e.target.value }))} className="mt-1 p-2 border-2 border-brandBlue bg-white text-slate-800 focus:outline-none focus:border-brandRed" required disabled={isSaving} />
                            </label>
                            {regError && <p className="text-brandRed text-sm font-bold mt-2 animate-pulse">{regError}</p>}
                            <button type="submit" disabled={isSaving || !authReady} className="btn-pixel-wrapper w-full group active:translate-y-1 transition-transform mt-4">
                                <div className="bg-brandBlue p-1 pixel-clip shadow-[4px_4px_0px_0px_#1e293b] flex items-center justify-center">
                                    <div className="pixel-inner bg-brandBlueLight w-full py-3 text-white font-bold text-xl pixel-clip flex items-center justify-center gap-3 group-hover:bg-blue-400">
                                        {isSaving ? 'GUARDANDO...' : <><Save className="w-6 h-6 mr-1" />GUARDAR</>}
                                    </div>
                                </div>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        );
        
        const LeaderboardModalComponent = ({ data, onClose, isLoading }) => {
            const sortedData = [...data].sort((a, b) => {
                if (b.score !== a.score) { return b.score - a.score; }
                return new Date(a.date) - new Date(b.date);
            }).slice(0, 10);

            return (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="w-full max-w-sm bg-brandYellow p-2 pixel-clip shadow-[8px_8px_0px_0px_rgba(0,0,0,0.8)]">
                        <div className="bg-white p-4 pixel-clip border-4 border-brandRed">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-3xl text-brandRed font-bold text-shadow-retro flex items-center gap-3"><Tally3 className="w-6 h-6"/>RANKING</h3>
                                <button onClick={onClose} className="text-brandRed hover:text-red-700 bg-brandYellow/50 p-1 pixel-clip shadow-[2px_2px_0px_0px_#7f1d1d]"><X className="w-6 h-6"/></button>
                            </div>
                            {isLoading ? (
                                <p className="text-center text-slate-600 font-bold animate-pulse">Cargando puntuaciones...</p>
                            ) : sortedData.length === 0 ? (
                                <p className="text-center text-slate-600 font-bold">¡Sé el primero en limpiar el mar y aparecer en el ranking!</p>
                            ) : (
                                <div className="space-y-2">
                                    {sortedData.map((item, index) => (
                                        <div key={item.id} className={`flex justify-between items-center p-3 pixel-clip ${index === 0 ? 'bg-brandYellow border-2 border-brandRed' : index === 1 ? 'bg-yellow-200' : index === 2 ? 'bg-yellow-100' : 'bg-slate-100'}`}>
                                            <span className="font-extrabold text-brandBlue text-2xl w-8 text-left">{index + 1}.</span>
                                            <span className="font-bold text-slate-800 text-lg flex-1 truncate ml-2">{item.name}</span>
                                            <span className="font-extrabold text-brandRed text-3xl">{item.score}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const fb = useFirebase();
            const [status, setStatus] = useState('SPLASH'); 
            const [score, setScore] = useState(0);
            const [highScore, setHighScore] = useState(0);
            const [gameOverMsg, setGameOverMsg] = useState(null);
            const [sessionId, setSessionId] = useState(0); 
            const [selectedChar, setSelectedChar] = useState('MATEO');
            const [controlType, setControlType] = useState('ARROWS');
            const [transitioning, setTransitioning] = useState(false); 
            
            const [authReady, setAuthReady] = useState(false);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isRegistered, setIsRegistered] = useState(false);
            const [showRegistrationModal, setShowRegistrationModal] = useState(false);
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [isLeaderboardLoading, setIsLeaderboardLoading] = useState(false);
            const [showLeaderboardModal, setShowLeaderboardModal] = useState(false);
            const [userName, setUserName] = useState(''); 

            const joystickRef = useRef({ x: 0, y: 0, active: false });
            const joystickStickRef = useRef(null);
            const joystickBaseRef = useRef(null);
            const blockPauseRef = useRef(false);
            const gameStartTime = useRef(0); 
            
            const [regForm, setRegForm] = useState({ name: '', documentId: '' });
            const [regError, setRegError] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const musicRef = useRef(new Audio(GAME_ASSETS.MUSIC_BG));
            const sfxCollectRef = useRef(new Audio(GAME_ASSETS.SFX_COLLECT));
            const sfxExplosionRef = useRef(new Audio(GAME_ASSETS.SFX_EXPLOSION));
            const sfxPowerUpRef = useRef(new Audio(GAME_ASSETS.SFX_POWERUP));
            const sfxPowerDestroyRef = useRef(new Audio(GAME_ASSETS.SFX_POWER_DESTROY));
            
            useEffect(() => {
                if (!fb.initializeApp) return;
                const app = fb.initializeApp(firebaseConfig);
                const firestoreDb = fb.getFirestore(app);
                const firebaseAuth = fb.getAuth(app);
                setDb(firestoreDb); setAuth(firebaseAuth);

                const unsubscribe = fb.onAuthStateChanged(firebaseAuth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        try {
                            if (initialAuthToken) { await fb.signInWithCustomToken(firebaseAuth, initialAuthToken); } 
                            else { await fb.signInAnonymously(firebaseAuth); }
                        } catch (error) { console.error("Firebase Auth Error:", error); }
                    }
                    setAuthReady(true);
                });
                return () => unsubscribe();
            }, [fb]);
            
            useEffect(() => {
                if (!authReady || !userId || !db) return;
                const userDocRef = fb.doc(db, `artifacts/${appId}/users/${userId}/user_profile/info`);
                const unsubscribe = fb.onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().name && docSnap.data().documentId) {
                        setIsRegistered(true); setUserName(docSnap.data().name); 
                        setRegForm({ name: docSnap.data().name || '', documentId: docSnap.data().documentId || '' });
                        console.log("Perfil de usuario cargado y registrado.");
                    } else {
                        setIsRegistered(false); setUserName(''); console.log("Usuario autenticado pero perfil no registrado.");
                    }
                }, (error) => { console.error("Error fetching user profile:", error); });
                return () => unsubscribe();
            }, [authReady, userId, db, fb]);
            
            useEffect(() => {
                if (!authReady || !db) return;
                setIsLeaderboardLoading(true);
                // RUTA CORREGIDA: 3 segmentos (Collection -> Doc -> Collection)
                const leaderboardCol = fb.collection(db, `artifacts/${appId}/leaderboard`);
                
                const unsubscribe = fb.onSnapshot(leaderboardCol, (snapshot) => {
                    const scores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setLeaderboardData(scores); setIsLeaderboardLoading(false);
                }, (error) => {
                    console.error("Error fetching leaderboard:", error); setIsLeaderboardLoading(false);
                });
                return () => unsubscribe();
            }, [authReady, db, fb]);

            const submitHighScore = useCallback(async (finalScore) => {
                if (!db || !userId || !userName || finalScore === 0) return;
                try {
                    // RUTA CORREGIDA
                    const leaderboardCol = fb.collection(db, `artifacts/${appId}/leaderboard`);
                    await fb.addDoc(leaderboardCol, { score: finalScore, name: userName, userId: userId, date: new Date().toISOString() });
                    console.log("Puntuación enviada al Leaderboard.");
                } catch (error) { console.error("Fallo al enviar la puntuación (Reglas de Seguridad o Auth):", error); }
            }, [db, userId, userName, fb]);

            const saveUserProfile = useCallback(async (e) => {
                e.preventDefault(); setRegError('');
                if (!regForm.name.trim() || !regForm.documentId.trim()) { setRegError('El nombre y el documento de identidad son obligatorios.'); return; }
                if (!db || !userId) { setRegError('Error de autenticación. Inténtalo de nuevo.'); return; }
                setIsSaving(true);
                try {
                    const userDocRef = fb.doc(db, `artifacts/${appId}/users/${userId}/user_profile/info`);
                    await fb.setDoc(userDocRef, { name: regForm.name.trim(), documentId: regForm.documentId.trim(), registrationDate: new Date().toISOString(), userId: userId }, { merge: true });
                    setShowRegistrationModal(false);
                } catch (error) {
                    console.error("Error saving user profile:", error); setRegError('Fallo al guardar. Por favor, revisa la consola para más detalles.');
                } finally { setIsSaving(false); }
            }, [regForm, db, userId, fb]);
            
            useEffect(() => {
                musicRef.current.loop = true; musicRef.current.volume = 0.4;
                sfxCollectRef.current.volume = 0.6; sfxExplosionRef.current.volume = 0.7;
                sfxPowerUpRef.current.volume = 0.7; sfxPowerDestroyRef.current.volume = 0.7;
            }, []);

            useEffect(() => {
                const music = musicRef.current;
                if (status === 'PAUSED') music.pause(); else if(status !== 'SPLASH' && isRegistered) music.play().catch(e => {}); 
            }, [status, isRegistered]);
            
            const playSfx = useCallback((type) => {
                if (type === 'COLLECT') { sfxCollectRef.current.currentTime = 0; sfxCollectRef.current.play().catch(e=>{}); }
                else if (type === 'EXPLOSION') { sfxExplosionRef.current.currentTime = 0; sfxExplosionRef.current.play().catch(e=>{}); }
                else if (type === 'POWERUP') { sfxPowerUpRef.current.currentTime = 0; sfxPowerUpRef.current.play().catch(e=>{}); }
                else if (type === 'POWER_DESTROY') { sfxPowerDestroyRef.current.currentTime = 0; sfxPowerDestroyRef.current.play().catch(e=>{}); }
            }, []);

            const emitInput = (key, type) => {
                const event = new CustomEvent(type === 'down' ? 'game-input-down' : 'game-input-up', { detail: { key } });
                window.dispatchEvent(event);
            };
            
            const transitionTo = (newStatus) => {
                setTransitioning(true); setTimeout(() => { setStatus(newStatus); setTransitioning(false); }, 500); 
            };
            
            const restartGame = () => {
                setSessionId(prev => prev + 1); setScore(0); joystickRef.current = { x: 0, y: 0, active: false };
                blockPauseRef.current = false; if (joystickStickRef.current) joystickStickRef.current.style.transform = `translate(0px, 0px)`;
                gameStartTime.current = Date.now();
                if (window.gtag) { window.gtag('event', 'game_restart', { character_name: selectedChar, control_type: controlType }); }
                setStatus('PLAYING');
            };

            const handleStart = useCallback(() => { 
                if (!isRegistered) { setShowRegistrationModal(true); return; }
                setTransitioning(true);
                setTimeout(() => {
                    setSessionId(prev => prev + 1); setScore(0); joystickRef.current = { x: 0, y: 0, active: false };
                    blockPauseRef.current = false; if (joystickStickRef.current) joystickStickRef.current.style.transform = `translate(0px, 0px)`;
                    gameStartTime.current = Date.now();
                    if (window.gtag) { window.gtag('event', 'game_start', { character_name: selectedChar, control_type: controlType }); }
                    setStatus('PLAYING'); setTransitioning(false);
                }, 500);
            }, [selectedChar, controlType, isRegistered]);

            const handleGameOver = useCallback((finalScore) => { 
               setStatus('GAME_OVER'); setHighScore(h => Math.max(h, finalScore)); 
               setGameOverMsg(CUSTOM_MESSAGES[Math.floor(Math.random() * CUSTOM_MESSAGES.length)]);
               if (isRegistered && finalScore > 0) { submitHighScore(finalScore); }
               const duration = (Date.now() - gameStartTime.current) / 1000;
               if (window.gtag) { window.gtag('event', 'game_complete', { score: finalScore, duration_seconds: duration, character_name: selectedChar }); }
            }, [selectedChar, isRegistered, submitHighScore]);
            
            const togglePause = () => { 
                if (blockPauseRef.current) return; 
                if (status === 'PLAYING') setStatus('PAUSED'); else if (status === 'PAUSED') setStatus('PLAYING'); 
            };
            
            const handleSplashClick = () => {
                if (!authReady) { console.log("Esperando inicialización de Firebase..."); return; }
                const music = musicRef.current;
                music.play().then(() => { if (isRegistered) { transitionTo('START'); } else { setShowRegistrationModal(true); } }).catch(e => { if (isRegistered) { transitionTo('START'); } else { setShowRegistrationModal(true); } });
            };

            const updateStick = useCallback((clientX, clientY) => {
                if (!joystickBaseRef.current || !joystickStickRef.current) return;
                const baseRect = joystickBaseRef.current.getBoundingClientRect();
                const centerX = baseRect.left + baseRect.width / 2; const centerY = baseRect.top + baseRect.height / 2;
                const deltaX = clientX - centerX; const deltaY = clientY - centerY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY); const maxDist = baseRect.width / 2;
                let clampedX = deltaX; let clampedY = deltaY;
                if (distance > maxDist) { const angle = Math.atan2(deltaY, deltaX); clampedX = Math.cos(angle) * maxDist; clampedY = Math.sin(angle) * maxDist; }
                joystickStickRef.current.style.transform = `translate(${clampedX}px, ${clampedY}px)`;
                joystickRef.current.x = clampedX / maxDist; joystickRef.current.y = clampedY / maxDist;
            }, []);

            const onGlobalMove = useCallback((e) => {
                if (!joystickRef.current.active) return;
                if(e.cancelable && e.type !== 'mousemove') e.preventDefault(); 
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { clientX = e.clientX; clientY = e.clientY; }
                updateStick(clientX, clientY);
            }, [updateStick]);

            const onGlobalEnd = useCallback((e) => {
                if (e.type === 'touchend') { if (e.cancelable) e.preventDefault(); }
                joystickRef.current.active = false; joystickRef.current.x = 0; joystickRef.current.y = 0;
                if (joystickStickRef.current) joystickStickRef.current.style.transform = `translate(0px, 0px)`;
                setTimeout(() => { blockPauseRef.current = false; }, 100);
                window.removeEventListener('mousemove', onGlobalMove); window.removeEventListener('mouseup', onGlobalEnd);
                window.removeEventListener('touchmove', onGlobalMove); window.removeEventListener('touchend', onGlobalEnd);
                window.removeEventListener('touchcancel', onGlobalEnd);
            }, [onGlobalMove]);

            const handleJoystickStart = useCallback((e) => {
                e.stopPropagation(); if(e.cancelable && e.type === 'touchstart') e.preventDefault(); 
                joystickRef.current.active = true; blockPauseRef.current = true; 
                window.addEventListener('mousemove', onGlobalMove); window.addEventListener('mouseup', onGlobalEnd);
                window.addEventListener('touchmove', onGlobalMove, { passive: false }); window.addEventListener('touchend', onGlobalEnd, { passive: false });
                window.addEventListener('touchcancel', onGlobalEnd, { passive: false });
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { clientX = e.clientX; clientY = e.clientY; }
                updateStick(clientX, clientY);
            }, [onGlobalMove, onGlobalEnd, updateStick]);

            return (
                <div className="w-full h-full bg-slate-900 flex justify-center items-center overflow-hidden font-pixel select-none relative">
                    <div className={`absolute inset-0 bg-black z-[100] pointer-events-none transition-opacity duration-500 ease-in-out ${transitioning ? 'opacity-100' : 'opacity-0'}`}></div>
                    <div className="relative h-full w-full mx-auto bg-black shadow-2xl overflow-hidden ring-4 ring-black/20" style={{ maxWidth: '56.25vh' }} onClick={() => { if (status === 'PLAYING' || status === 'PAUSED') togglePause(); }}>
                        <div className="absolute inset-0 z-0 bg-[#0369a1]">
                            <GameCanvas sessionId={sessionId} status={status} onScoreUpdate={setScore} onGameOver={handleGameOver} playSfx={playSfx} playerSrc={GAME_ASSETS['PLAYER_' + selectedChar]} joystickRef={joystickRef} />
                        </div>
                        <div className="scanline z-10 opacity-30 pointer-events-none"></div>
                        {(status !== 'START' && status !== 'SPLASH') && (
                            <div className="absolute top-8 left-0 right-0 z-20 px-4 pointer-events-none">
                                <div className="relative bg-brandYellow p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] pointer-events-auto">
                                    <div className="bg-brandRed h-16 flex items-center justify-between px-4 text-white w-full pixel-clip">
                                        <div className="flex items-center gap-2"><Trash2 className="w-5 h-5 text-brandYellow" /><span className="text-2xl font-bold tracking-widest text-shadow-retro">{score.toString().padStart(5,'0')}</span></div>
                                        <div className="flex items-center gap-2"><Award className="w-5 h-5 text-brandYellow" /><span className="text-2xl font-bold tracking-widest text-shadow-retro">{highScore.toString().padStart(5,'0')}</span></div>
                                    </div>
                                </div>
                                <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 h-24 w-40 flex items-center justify-center pointer-events-none"><img src={GAME_ASSETS.LOGO} alt="Marinero Logo" className="h-20 object-contain drop-shadow-xl z-10 animate-logo-pulse" /></div>
                            </div>
                        )}
                        {(status === 'PLAYING' || status === 'PAUSED') && (
                            <div className="absolute bottom-0 left-0 right-0 z-30 p-4 pb-8 flex justify-between items-end pointer-events-none select-none">
                                {controlType === 'ARROWS' ? (
                                    <>
                                        <div className="flex gap-4 pointer-events-auto" onClick={(e) => e.stopPropagation()}>
                                            <div className="btn-pixel-wrapper w-16 h-16 md:w-20 md:h-20 active:translate-y-1 transition-transform touch-manipulation">
                                                <div className="w-full h-full bg-[#ca8a04] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]" onTouchStart={(e) => { e.preventDefault(); emitInput('ArrowLeft', 'down'); }} onTouchEnd={(e) => { e.preventDefault(); emitInput('ArrowLeft', 'up'); }} onMouseDown={() => emitInput('ArrowLeft', 'down')} onMouseUp={() => emitInput('ArrowLeft', 'up')} onMouseLeave={() => emitInput('ArrowLeft', 'up')}>
                                                    <div className="pixel-inner w-full h-full bg-brandYellow pixel-clip flex items-center justify-center transition-transform"><ChevronLeft className="w-10 h-10 text-brandRed" strokeWidth={4} /></div>
                                                </div>
                                            </div>
                                            <div className="btn-pixel-wrapper w-16 h-16 md:w-20 md:h-20 active:translate-y-1 transition-transform touch-manipulation">
                                                <div className="w-full h-full bg-[#ca8a04] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]" onTouchStart={(e) => { e.preventDefault(); emitInput('ArrowRight', 'down'); }} onTouchEnd={(e) => { e.preventDefault(); emitInput('ArrowRight', 'up'); }} onMouseDown={() => emitInput('ArrowRight', 'down')} onMouseUp={() => emitInput('ArrowRight', 'up')} onMouseLeave={() => emitInput('ArrowRight', 'up')}>
                                                    <div className="pixel-inner w-full h-full bg-brandYellow pixel-clip flex items-center justify-center transition-transform"><ChevronRight className="w-10 h-10 text-brandRed" strokeWidth={4} /></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="pointer-events-auto" onClick={(e) => e.stopPropagation()}>
                                            <div className="btn-pixel-wrapper w-20 h-20 md:w-24 md:h-24 active:translate-y-1 transition-transform touch-manipulation">
                                                <div className="w-full h-full bg-[#7f1d1d] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]" onTouchStart={(e) => { e.preventDefault(); emitInput(' ', 'down'); }} onTouchEnd={(e) => { e.preventDefault(); emitInput(' ', 'up'); }} onMouseDown={() => emitInput(' ', 'down')} onMouseUp={() => emitInput(' ', 'up')} onMouseLeave={() => emitInput(' ', 'up')}>
                                                    <div className="pixel-inner w-full h-full bg-brandRed pixel-clip flex flex-col items-center justify-center transition-transform leading-none"><ArrowUp className="w-10 h-10 text-white mb-0" strokeWidth={4} /><span className="text-xl font-bold text-white text-shadow-retro leading-none tracking-widest">NADAR</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="w-full flex justify-center pb-4 pointer-events-auto" onClick={e => e.stopPropagation()}>
                                        <div ref={joystickBaseRef} className="w-32 h-32 rounded-full bg-[#ca8a04]/80 border-4 border-brandYellow relative shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] touch-none" onMouseDown={handleJoystickStart} onTouchStart={handleJoystickStart}>
                                            <div ref={joystickStickRef} className="w-12 h-12 bg-brandRed rounded-full absolute top-1/2 left-1/2 -ml-6 -mt-6 border-2 border-[#fecaca] shadow-lg pointer-events-none" />
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {(status !== 'PLAYING' || showRegistrationModal || showLeaderboardModal) && (
                            <div className={`absolute inset-0 z-40 flex items-center justify-center ${status === 'SPLASH' && !showRegistrationModal && !showLeaderboardModal ? 'bg-transparent' : 'bg-black/60 backdrop-blur-sm'}`} onClick={(e) => { if (status === 'PAUSED') togglePause(); }}>
                                {status === 'SPLASH' && !showRegistrationModal && !showLeaderboardModal && (
                                    <div className="absolute inset-0 z-50 flex flex-col items-center justify-center cursor-pointer overflow-hidden" onClick={handleSplashClick}>
                                        <img src={GAME_ASSETS.SPLASH_BG} className="absolute inset-0 w-full h-full object-cover" alt="Playa Background" />
                                        <div className="absolute inset-0 bg-black/30"></div> <div className="scanline z-10 opacity-20 pointer-events-none"></div>
                                        <img src={GAME_ASSETS.LOGO} className="w-64 object-contain animate-bounce mb-8 z-20 relative" alt="Logo" />
                                        <p className="absolute bottom-40 text-white text-2xl font-bold animate-pulse text-shadow-retro tracking-widest z-20 w-full text-center">TOCA LA PANTALLA PARA EMPEZAR</p>
                                        <img src={GAME_ASSETS.IMAGINED_BY} className="absolute bottom-8 w-24 object-contain z-20 opacity-80 drop-shadow-md" alt="Imagined by BG" />
                                        {!authReady && <p className="absolute top-4 right-4 text-xs text-brandYellow z-20">Conectando...</p>}
                                        {authReady && userId && <p className="absolute top-4 right-4 text-xs text-white z-20">ID: {userId.substring(0, 8)}...</p>}
                                    </div>
                                )}
                                {showRegistrationModal && (
                                    <RegistrationModalComponent userId={userId} regForm={regForm} setRegForm={setRegForm} regError={regError} isSaving={isSaving} authReady={authReady} saveUserProfile={saveUserProfile} />
                                )}
                                {showLeaderboardModal && (
                                    <LeaderboardModalComponent data={leaderboardData} onClose={() => setShowLeaderboardModal(false)} isLoading={isLeaderboardLoading} />
                                )}
                                {status === 'PAUSED' && !showRegistrationModal && !showLeaderboardModal && (
                                    <div className="flex flex-col items-center animate-in fade-in zoom-in duration-200 pointer-events-none">
                                        <h2 className="text-6xl text-brandYellow font-bold text-shadow-retro mb-4 animate-pulse">PAUSA</h2> <p className="text-white text-xl text-shadow-retro animate-bounce">TOCA PARA CONTINUAR</p>
                                    </div>
                                )}
                                {status === 'START' && !showRegistrationModal && !showLeaderboardModal && (
                                    <div className={`absolute -inset-1 z-50 flex flex-col items-center justify-center p-6 text-white w-[calc(100%+8px)] h-[calc(100%+8px)] bg-black/10 backdrop-blur-sm`} onClick={(e) => e.stopPropagation()}>
                                        <img src={GAME_ASSETS.LOGO} alt="Marinero" className="w-48 object-contain mb-6 animate-logo-pulse" />
                                        <h3 className="text-white font-bold text-4xl mb-8 leading-[0.75] text-shadow-retro text-center px-4 tracking-widest">¡AYUDA A MATEO<br />Y SUS AMIGOS<br />A LIMPIAR EL MAR!</h3>
                                        <div className="flex flex-col items-center w-full max-w-sm gap-6">
                                            <div className="w-full flex flex-col items-center">
                                                <p className="text-white text-lg mb-2 text-shadow-retro">Escoge a tu personaje favorito:</p>
                                                <div className="grid grid-cols-4 gap-3 mb-2">
                                                    {['MATEO', 'ANA', 'CARLITOS', 'MARCO'].map(char => (
                                                        <div key={char} onClick={() => setSelectedChar(char)} className={`w-16 h-16 bg-[#1e293b] pixel-clip flex items-center justify-center cursor-pointer transition-all border-4 ${selectedChar === char ? 'border-brandYellow bg-[#334155]' : 'border-transparent hover:bg-[#334155]'}`}><img src={GAME_ASSETS['PLAYER_' + char]} className="w-12 h-12 object-contain" /></div>
                                                    ))}
                                                </div>
                                                <div className="text-brandYellow font-bold text-2xl text-shadow-retro uppercase tracking-widest">{selectedChar}</div>
                                            </div>
                                            <div className="w-full flex flex-col items-center">
                                                <p className="text-white text-base mb-2 text-shadow-retro">Tipo de Control:</p>
                                                <div className="flex gap-4">
                                                    <button onClick={() => setControlType('ARROWS')} className={`px-4 py-2 pixel-clip border-2 ${controlType === 'ARROWS' ? 'bg-brandYellow text-brandRed border-white' : 'bg-[#1e293b] text-slate-400 border-transparent'} flex items-center gap-2 transition-all`}><Move className="w-5 h-5" /><span className="text-lg font-bold">FLECHAS</span></button>
                                                    <button onClick={() => setControlType('JOYSTICK')} className={`px-4 py-2 pixel-clip border-2 ${controlType === 'JOYSTICK' ? 'bg-brandYellow text-brandRed border-white' : 'bg-[#1e293b] text-slate-400 border-transparent'} flex items-center gap-2 transition-all`}><Gamepad2 className="w-5 h-5" /><span className="text-lg font-bold">JOYSTICK</span></button>
                                                </div>
                                            </div>
                                            <button onClick={handleStart} className="btn-pixel-wrapper w-20 h-20 group active:translate-y-1 transition-transform mt-4">
                                                <div className="bg-brandRed p-1 pixel-clip shadow-[4px_4px_0px_0px_#a16207]"><div className="pixel-inner bg-brandYellow w-full h-full text-brandRed pixel-clip flex items-center justify-center group-hover:bg-yellow-300"><Play className="fill-current w-10 h-10" /></div></div>
                                            </button>
                                            <button onClick={() => setShowLeaderboardModal(true)} className="btn-pixel-wrapper group active:translate-y-1 transition-transform mt-4 w-48">
                                                <div className="bg-brandBlue p-1 pixel-clip shadow-[4px_4px_0px_0px_#1e293b]"><div className="pixel-inner bg-brandBlueLight w-full py-3 text-white font-bold text-xl pixel-clip flex items-center justify-center gap-3 group-hover:bg-blue-400"><Tally3 className="w-5 h-5" />RANKING</div></div>
                                            </button>
                                        </div>
                                    </div>
                                )}
                                {status === 'GAME_OVER' && !showRegistrationModal && !showLeaderboardModal && (
                                    <div className="w-full max-w-xs animate-in slide-in-from-bottom duration-500" onClick={(e) => e.stopPropagation()}>
                                        <div className="bg-brandBlue p-1 pixel-clip shadow-[8px_8px_0px_0px_rgba(0,0,0,0.5)]">
                                            <div className="bg-white p-1 pixel-clip">
                                                <div className="bg-[#f0f9ff] p-2 text-center flex flex-col items-center pixel-clip relative">
                                                    <img src={GAME_ASSETS.LOGO} alt="Marinero" className="h-12 object-contain mb-1 animate-bounce" />
                                                    <div className="mb-2 text-center">
                                                        <div className="text-xl text-slate-500 font-bold uppercase leading-none mb-[-10px]">Puntuación Final</div> <div className="text-8xl font-black text-brandYellow text-shadow-retro leading-[0.75]">{score}</div>
                                                    </div>
                                                    {gameOverMsg && (
                                                        <div className="relative w-full mb-2">
                                                            <img src={GAME_ASSETS.FRAME_RESULT} className="w-full h-auto object-contain pixel-clip" alt="Result Frame" />
                                                            <div className="absolute bottom-0 left-0 right-0 h-[66%] flex flex-col items-center justify-center px-4 text-center leading-none">
                                                                <div className="text-brandBlue font-bold text-3xl uppercase mb-0 leading-none">{gameOverMsg.title}</div> <p className="text-2xl text-slate-600 italic leading-none">"{gameOverMsg.message}"</p>
                                                            </div>
                                                        </div>
                                                    )}
                                                    <div className="flex flex-col gap-2 w-full">
                                                        <button onClick={restartGame} className="btn-pixel-wrapper w-full group active:translate-y-1 transition-transform">
                                                            <div className="bg-white p-1 pixel-clip shadow-[4px_4px_0px_0px_#7f1d1d]"><div className="pixel-inner bg-brandRed py-3 text-white font-bold text-2xl pixel-clip flex items-center justify-center gap-3 group-hover:bg-red-600"><RotateCcw className="w-8 h-8 mr-1" />REINTENTAR</div></div>
                                                        </button>
                                                        <button onClick={() => setShowLeaderboardModal(true)} className="btn-pixel-wrapper w-full group active:translate-y-1 transition-transform">
                                                            <div className="bg-white p-1 pixel-clip shadow-[4px_4px_0px_0px_#1e293b]"><div className="pixel-inner bg-brandBlue py-3 text-white font-bold text-2xl pixel-clip flex items-center justify-center gap-3 group-hover:bg-blue-600"><Tally3 className="w-8 h-8 mr-1" />RANKING</div></div>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
